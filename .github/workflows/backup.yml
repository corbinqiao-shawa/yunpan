name: è‡ªåŠ¨å¤‡ä»½Twitteråˆ°ç™¾åº¦ç½‘ç›˜
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©å‡Œæ™¨0ç‚¹è‡ªåŠ¨è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹ï¼‰
  workflow_dispatch:      # ä¹Ÿå¯ä»¥æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: å‡†å¤‡å·¥ä½œç¯å¢ƒ
        uses: actions/checkout@v4
        
      - name: å®‰è£…Pythonå’Œå°å·¥å…·
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: å®‰è£…å¤‡ä»½éœ€è¦çš„é­”æ³•åº“ï¼ˆæœ€æ–°ç‰ˆï¼‰
        run: |
          pip install --upgrade pip
          pip install --upgrade bypy ntscraper
    
          
      - name: åˆ›å»ºå¤‡ä»½è„šæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
        run: |
          echo "from ntscraper import Nitter; import json; import os; from datetime import datetime" > backup.py
          echo "scraper = Nitter(instance='https://nitter.net', log_level=2)" >> backup.py  # è¯¦ç»†æ—¥å¿—
          echo "try:" >> backup.py
          echo "    tweets = scraper.get_tweets('${{ secrets.TWITTER_USERNAME }}', mode='user', number=100)" >> backup.py
          echo "    today = datetime.now().strftime('%Y-%m-%d')" >> backup.py
          echo "    filename = f'twitter_backup_{today}.json'" >> backup.py
          echo "    with open(filename, 'w', encoding='utf-8') as f:" >> backup.py
          echo "        json.dump(tweets, f, ensure_ascii=False, indent=2)" >> backup.py
          echo "    print('âœ… æˆåŠŸæŠ“å–å¹¶ä¿å­˜å¤‡ä»½æ–‡ä»¶')" >> backup.py
          echo "except Exception as e:" >> backup.py
          echo "    print(f'âŒ æŠ“å–Twitterå†…å®¹å¤±è´¥: {e}')" >> backup.py
          echo "    exit(0)  # å³ä½¿æŠ“å–å¤±è´¥ï¼Œä¹Ÿä¸è¦è®©æ•´ä¸ªå·¥ä½œæµå¤±è´¥" >> backup.py
          
      - name: è¿æ¥ç™¾åº¦ç½‘ç›˜å¹¶ä¸Šä¼ å¤‡ä»½
        run: |
        # ä¿®å¤æˆæƒæ–¹å¼ï¼Œé¿å…exit code 40
         bypy authorize --refresh --code "${{ secrets.BAIDU_TOKEN }}"
         # ç¡®ä¿ç›®å½•å­˜åœ¨
         bypy mkdir -p /twitter-backups/ || true
        # æ£€æŸ¥æ–‡ä»¶å†ä¸Šä¼ 
        if [ -f twitter_backup_*.json ]; then
          bypy upload twitter_backup_*.json /twitter-backups/
          echo "ğŸ‰ ä¸Šä¼ æˆåŠŸï¼"
       else
         echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
      fi
    
          
      - name: æ˜¾ç¤ºå¤‡ä»½ç»“æœ
        run: |
          echo "ğŸ“‹ å¤‡ä»½ä»»åŠ¡å®ŒæˆçŠ¶æ€ï¼š"
          ls -l twitter_backup_*.json || echo "æ²¡æœ‰å¤‡ä»½æ–‡ä»¶"
          bypy list /twitter-backups/ || echo "ç™¾åº¦ç½‘ç›˜ç›®å½•æŸ¥çœ‹å¤±è´¥"
